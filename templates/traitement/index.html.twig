{% extends 'baseback.html.twig' %}

{% block title %}Liste des Traitements{% endblock %}

{% block body %}
<style>
    #searchInput { margin-top: 10px; }
    
    .popup { 
        display: none; 
        position: fixed; 
        top: 50%; 
        left: 50%; 
        transform: translate(-50%, -50%); 
        background: white; 
        padding: 20px; 
        border-radius: 10px; 
        box-shadow: 0px 0px 10px rgba(0,0,0,0.2);
        width: 400px;
        text-align: center;
    }
    .popup button { margin-top: 10px; }
    .medicament-name {
        color: blue;
        cursor: pointer;
        text-decoration: underline;
    }
</style>

<div class="pagetitle">
    <h1>Liste des Traitements</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ path('app_backpage') }}">Home</a></li>
            <li class="breadcrumb-item active">Liste des Traitements</li>
        </ol>
    </nav>
</div>

<div class="container mt-4">
    <div class="card">
        <div class="card-body">
            <!-- Search Input -->
            <input type="text" id="searchInput" class="form-control mb-3" placeholder="Rechercher un traitement...">

            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Prescription associée</th>
                        <th>Médicament</th>
                        <th>Dosage</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    {% for traitement in traitements %}
                        <tr>
                            <td>{{ traitement.prescription.datedeb|date('d/m/Y') }} - {{ traitement.prescription.datefin|date('d/m/Y') }}</td>
                            <td>
                                <span class="medicament-name" data-name="{{ traitement.medicament }}">{{ traitement.medicament }}</span>
                            </td>
                            <td>{{ traitement.dose }}</td>
                            <td>{{ traitement.description }}</td>
                            <td>
                                <a href="{{ path('traitement_edit', {id: traitement.id}) }}" class="btn btn-warning btn-sm">Modifier</a>
                                <a href="{{ path('traitement_delete', {id: traitement.id}) }}" class="btn btn-danger btn-sm">Supprimer</a>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="5">Aucun traitement trouvé.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Popup Modal -->
<div id="popup" class="popup">
    <h3 id="popup-title">Informations sur le médicament</h3>
    <p><strong>Dosage:</strong> <span id="popup-dosage"></span></p>
    <p><strong>Description:</strong> <span id="popup-desc"></span></p>
    <p><strong>Effets secondaires:</strong> <span id="popup-effects"></span></p>
    <button onclick="closePopup()">Fermer</button>
</div>

<script>
    document.querySelectorAll(".medicament-name").forEach(medName => {
        medName.addEventListener("click", function () {
            let medicament = this.getAttribute("data-name");

            if (medicament) {
                fetch(`/api/medicament?name=${medicament}`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.error) {
                            document.getElementById("popup-title").innerText = medicament;
                            document.getElementById("popup-dosage").innerText = data.dosage;
                            document.getElementById("popup-desc").innerText = data.description;
                            document.getElementById("popup-effects").innerText = data.side_effects;
                            
                            // Show popup
                            document.getElementById("popup").style.display = "block";
                        } else {
                            alert("Aucune information trouvée.");
                        }
                    })
                    .catch(error => console.error("Erreur API:", error));
            }
        });
    });

    function closePopup() {
        document.getElementById("popup").style.display = "none";
    }


    document.getElementById("searchInput").addEventListener("keyup", function() {
    let filter = this.value.toLowerCase();
    let rows = document.querySelectorAll("#tableBody tr");

    rows.forEach(row => {
        let text = row.innerText.toLowerCase();
        if (text.includes(filter)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
});

</script>

{% endblock %}
